<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="./foredawn_vue/lib/vue.js"></script>
  <script src="./foredawn_vue/lib/axios.js"></script>
  <script src="./foredawn_vue/lib/vue-router.js"></script>
</head>

<body>
  <!-- 
    ``借助axios的拦截器和路由守卫实现vue开发后台中的登录校验思路``
    需要引入vue axios vue-router

    首先先根据你的具体业务场景去确定你这个路由是否需要登录才能访问 不需要就不访问
    (通过meta里requireAuth = true 表示此路由需要权限校验)
    如果需要登录 在去检测是否存在过登录状态 在login登录过的会得到token令牌存储在Storage
    或者vuex里 如果存在就跳转 不存在就给他定回login去登录
    但是token存在问题
    什么时候失效登录时间太长 超出登录最长时效期 还有安全性易被伪造
    所以还需要一个axios的拦截器 在发请求的时候通过后端进一步去保证权限状态的准确性
    在每次请求时设置请求拦截器 如果前端有token就带过去 让后端在进行一次权限校验
    然后在开启一个响应拦截器 返回一个权限校验完成的结果 根据token的失效有否去做措施

    在进行所有除了login登录的所有请求都要尝试去localStorage里获取token,没有就获得"" ,
    并 在config.headers['Authorization'] = localStorage.getItem("demotoken") || ""请求头里携带token
    后端服务器在处理某些请求的时候去验证token,如果token不正确或过期就返回401,
    客户端收到401就会路由到login并清除token
    在进行所有路由都会经过前置守卫,守卫会验证这个路由需不需要登录,如果需要就尝试去localStorage里获取token
    没有token去直接路由到login(不管token过不过期),进入后将会发送ajax获取数据,如果token不正确或过期就返回401
    将会清除token并跳转到login?redirect=cart
    登陆成功后直接跳到redirect
    代码展示如下:
   -->

  <tamplate id="index">
    <div>首页</div>
  </tamplate>

  <template id="cart">
    <div>
      <p>购物车</p>
      <button @click=handleLoginOut>退出登录</button>
    </div>
  </template>

  <template id="login">
    <div>
      姓名: <input type="text" v-model="username"><br>
      密码: <input type="password" v-model="password"><br>
      <button @click=handleLogin>点击登录</button>
    </div>
  </template>

  <div id="app">
    <router-link to="/index">首页</router-link>
    <router-link to="/cart">购物车</router-link>
    <router-link to="/login">登录页</router-link>
    <hr />
    <router-view></router-view>
  </div>
  <script>
    const router = new VueRouter({
      routes: [{
          path: '/',
          redirect: '/index'
        },
        {
          path: '/cart',
          meta: {
            requireAuth: true
          },
          component: {
            template: "#cart",
            methods: {
              handleLoginOut() {
                this.$router.push("/login")
                localStorage.removeItem('_token')
              }
            }
          }
        }, {
          path: '/login',
          component: {
            template: "#login",
            data() {
              return {
                username: '',
                password: ''
              }
            },
            methods: {
              async handleLogin() {
                const res = await axios.post(
                  "http://localhost:8888/api/private/v1/login", {
                    username: this.username,
                    password: this.password
                  }
                )
                const {
                  status,
                  data
                } = res
                if (status === 200) {
                  if (data.meta.status === 200) {
                    localStorage.setItem("_token", data.data.token)
                    const path = this.$route.query.redirect || 'index'
                    this.$router.push("/index")
                  } else {
                    alert('用户名或者密码错误')
                    localStorage.removeItem("_token")
                  }
                }
              }
            }
          }
        }
      ]
    })

    router.beforeEach((to, from, next) => {
      if (to.meta.requireAuth) {
        if (localStorage.getItem("_token")) {
          next()
        } else {
          next({
            path:'/login',
            query:{
              redirect:to.fullPath
            }
          })
        }
      } else {
        next()
      }
    })

    axios.interceptors.request.use(config => {
      if(!config.url.endsWith('/login')) {
        config.headers.Authorization = localStorage.getItem('_token') || ''
      }
      return config
    })

    axios.interceptors.response.use(response => {
      if(response.data.meta.status === 401) {
        router.push('/login')
        localStorage.removeItem('_token')
      }
      return response
    },error => {
      console.log(error.response)
      return error
    })

    var el = new Vue({
      el: "#app",
      data: {},
      router
    })
  </script>
</body>

</html>